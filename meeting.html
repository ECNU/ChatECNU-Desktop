<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>会议助手</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
      background: #1a1a2e;
      color: #fff;
      overflow: hidden;
    }

    /* 标题栏 */
    .window-header {
      height: 40px;
      background: rgba(102, 126, 234, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      -webkit-app-region: drag;
    }
    .window-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
    }
    .window-title svg {
      width: 18px;
      height: 18px;
    }
    .window-controls {
      display: flex;
      align-items: center;
      gap: 4px;
      -webkit-app-region: no-drag;
    }
    .window-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .window-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    .window-btn.pinned {
      color: #667eea;
    }
    .window-btn.pinned:hover {
      color: #8e9ff0;
    }

    /* 状态区域 */
    .status-section {
      padding: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .status-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #666;
    }
    .status-indicator.idle { background: #666; }
    .status-indicator.recording {
      background: #e53935;
      animation: blink 1s ease-in-out infinite;
    }
    .status-indicator.ended { background: #4caf50; }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .status-text {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.9);
    }
    .status-time {
      margin-left: auto;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.5);
      font-variant-numeric: tabular-nums;
    }

    /* 讲话人区域 */
    .speaker-section {
      padding: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .section-label {
      color: rgba(255, 255, 255, 0.5);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }
    .speaker-name {
      color: #667eea;
      font-size: 14px;
      font-weight: 500;
    }
    .transcript-text {
      color: rgba(255, 255, 255, 0.8);
      font-size: 13px;
      line-height: 1.6;
      margin-top: 8px;
      max-height: 80px;
      overflow-y: auto;
    }
    .transcript-text::-webkit-scrollbar {
      width: 4px;
    }
    .transcript-text::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
    }

    /* 摘要区域 */
    .summary-section {
      padding: 16px;
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .summary-content {
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      line-height: 1.6;
      flex: 1;
      overflow-y: auto;
    }
    .summary-content::-webkit-scrollbar {
      width: 4px;
    }
    .summary-content::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
    }
    .summary-empty {
      color: rgba(255, 255, 255, 0.3);
      font-style: italic;
    }

    /* 操作按钮区域 */
    .action-section {
      padding: 16px;
      display: flex;
      gap: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    .action-btn {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-start {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    .btn-start:hover:not(:disabled) {
      background: linear-gradient(135deg, #5a6fd6, #6a4190);
    }
    .btn-end {
      background: rgba(229, 57, 53, 0.9);
      color: white;
    }
    .btn-end:hover:not(:disabled) {
      background: rgba(211, 47, 47, 1);
    }
    .btn-icon {
      width: 16px;
      height: 16px;
    }

    /* 错误提示 */
    .error-toast {
      display: none;
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(229, 57, 53, 0.95);
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 13px;
    }
    .error-toast.visible {
      display: block;
      animation: fadeInOut 3s ease-in-out forwards;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      85% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* 主容器 */
    .container {
      display: flex;
      flex-direction: column;
      height: calc(100% - 40px);
    }
  </style>
</head>
<body>
  <div class="window-header">
    <div class="window-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
        <line x1="12" y1="19" x2="12" y2="23"/>
        <line x1="8" y1="23" x2="16" y2="23"/>
      </svg>
      会议助手
    </div>
    <div class="window-controls">
      <button class="window-btn" id="btnPin" title="置顶">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="17" x2="12" y2="22"/>
          <path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"/>
        </svg>
      </button>
      <button class="window-btn" id="btnClose" title="关闭">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="container">
    <div class="status-section">
      <div class="status-row">
        <div class="status-indicator" id="statusIndicator"></div>
        <span class="status-text" id="statusText">未开始</span>
        <span class="status-time" id="statusTime">00:00:00</span>
      </div>
    </div>

    <div class="speaker-section">
      <div class="section-label">当前讲话人</div>
      <div class="speaker-name" id="speakerName">--</div>
      <div class="transcript-text" id="transcriptText">等待录音开始...</div>
    </div>

    <div class="summary-section">
      <div class="section-label">实时摘要</div>
      <div class="summary-content" id="summaryContent">
        <span class="summary-empty">会议开始后将自动生成摘要</span>
      </div>
    </div>

    <div class="action-section">
      <button class="action-btn btn-start" id="btnStart">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
          <circle cx="12" cy="12" r="10"/>
        </svg>
        开始会议
      </button>
      <button class="action-btn btn-end" id="btnEnd" disabled>
        <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
          <rect x="6" y="6" width="12" height="12" rx="2"/>
        </svg>
        结束会议
      </button>
    </div>
  </div>

  <div class="error-toast" id="errorToast"></div>

  <script>
    const { ipcRenderer, desktopCapturer } = require('electron');

    const btnClose = document.getElementById('btnClose');
    const btnPin = document.getElementById('btnPin');
    const btnStart = document.getElementById('btnStart');
    const btnEnd = document.getElementById('btnEnd');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const statusTime = document.getElementById('statusTime');
    const speakerName = document.getElementById('speakerName');
    const transcriptText = document.getElementById('transcriptText');
    const summaryContent = document.getElementById('summaryContent');
    const errorToast = document.getElementById('errorToast');

    let isPinned = false;

    // 关闭窗口
    btnClose.onclick = () => {
      ipcRenderer.send('close-meeting-window');
    };

    // 置顶窗口
    btnPin.onclick = () => {
      isPinned = !isPinned;
      ipcRenderer.send('meeting-set-always-on-top', isPinned);
      btnPin.classList.toggle('pinned', isPinned);
      btnPin.title = isPinned ? '取消置顶' : '置顶';
    };

    // ========== 录音模块 ==========
    class AudioRecorder {
      constructor() {
        this.mediaRecorder = null;
        this.audioContext = null;
        this.micStream = null;
        this.systemStream = null;
        this.sequence = 0;
        this.isRecording = false;
        this.chunkInterval = 5000;
      }

      async getMicrophoneStream() {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true, sampleRate: 16000 },
          video: false
        });
        return stream;
      }

      async getSystemAudioStream() {
        try {
          const sources = await desktopCapturer.getSources({ types: ['screen'] });
          if (sources.length === 0) return null;

          const stream = await navigator.mediaDevices.getUserMedia({
            audio: { mandatory: { chromeMediaSource: 'desktop', chromeMediaSourceId: sources[0].id } },
            video: { mandatory: { chromeMediaSource: 'desktop', chromeMediaSourceId: sources[0].id, maxWidth: 1, maxHeight: 1, maxFrameRate: 1 } }
          });

          stream.getVideoTracks().forEach(t => t.stop());
          const audioTracks = stream.getAudioTracks();
          return audioTracks.length > 0 ? new MediaStream(audioTracks) : null;
        } catch (error) {
          return null;
        }
      }

      mixStreams(streams) {
        const valid = streams.filter(s => s !== null);
        if (valid.length === 0) throw new Error('没有可用的音频源');
        if (valid.length === 1) return valid[0];

        this.audioContext = new AudioContext({ sampleRate: 16000 });
        const dest = this.audioContext.createMediaStreamDestination();
        valid.forEach(s => this.audioContext.createMediaStreamSource(s).connect(dest));
        return dest.stream;
      }

      async start(onChunk) {
        if (this.isRecording) return;

        const streams = [];
        this.micStream = await this.getMicrophoneStream();
        streams.push(this.micStream);

        this.systemStream = await this.getSystemAudioStream();
        if (this.systemStream) streams.push(this.systemStream);

        const mixed = this.mixStreams(streams);
        
        this.mediaRecorder = new MediaRecorder(mixed, {
          mimeType: 'audio/webm;codecs=opus',
          audioBitsPerSecond: 64000
        });

        this.sequence = 0;

        this.mediaRecorder.ondataavailable = async (e) => {
          if (e.data.size > 0) {
            this.sequence++;
            const reader = new FileReader();
            reader.onloadend = () => {
              const base64 = reader.result.split(',')[1];
              if (onChunk) onChunk(base64, this.sequence, Date.now());
            };
            reader.readAsDataURL(e.data);
          }
        };

        this.mediaRecorder.start(this.chunkInterval);
        this.isRecording = true;
      }

      async stop() {
        if (!this.isRecording) return;
        return new Promise(resolve => {
          this.mediaRecorder.onstop = () => { this.cleanup(); resolve(); };
          this.mediaRecorder.stop();
          this.isRecording = false;
        });
      }

      cleanup() {
        [this.micStream, this.systemStream].forEach(s => { if (s) s.getTracks().forEach(t => t.stop()); });
        if (this.audioContext) this.audioContext.close();
        this.micStream = null;
        this.systemStream = null;
        this.audioContext = null;
      }
    }

    const recorder = new AudioRecorder();

    // ========== 会议状态 ==========
    let meetingState = { isRecording: false, startTime: null, timerInterval: null };

    function showError(message) {
      errorToast.textContent = message;
      errorToast.classList.remove('visible');
      void errorToast.offsetWidth;
      errorToast.classList.add('visible');
      setTimeout(() => errorToast.classList.remove('visible'), 3000);
    }

    function updateTimer() {
      if (!meetingState.startTime) return;
      const elapsed = Math.floor((Date.now() - meetingState.startTime) / 1000);
      const h = Math.floor(elapsed / 3600).toString().padStart(2, '0');
      const m = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
      const s = (elapsed % 60).toString().padStart(2, '0');
      statusTime.textContent = `${h}:${m}:${s}`;
    }

    async function onAudioChunk(audioData, sequence, timestamp) {
      try {
        await ipcRenderer.invoke('meeting-submit-audio', { audioData, sequence, timestamp });
      } catch (err) {
        console.error('[Meeting] 音频提交异常:', err);
      }
    }

    // 开始会议
    btnStart.onclick = async () => {
      btnStart.disabled = true;
      btnStart.textContent = '启动中...';
      
      try {
        await recorder.start(onAudioChunk);
        const result = await ipcRenderer.invoke('meeting-start');
        
        if (result.success) {
          meetingState.isRecording = true;
          meetingState.startTime = Date.now();
          meetingState.timerInterval = setInterval(updateTimer, 1000);
          
          statusIndicator.className = 'status-indicator recording';
          statusText.textContent = '录音中';
          transcriptText.textContent = '正在录音...';
          
          btnStart.style.display = 'none';
          btnEnd.disabled = false;
        } else {
          await recorder.stop();
          showError(result.error || '启动失败');
          btnStart.disabled = false;
        }
      } catch (err) {
        await recorder.stop();
        showError(err.message || '启动失败');
        btnStart.disabled = false;
      }
      
      btnStart.innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>开始会议';
    };

    // 结束会议
    btnEnd.onclick = async () => {
      btnEnd.disabled = true;
      btnEnd.textContent = '结束中...';
      
      try {
        await recorder.stop();
        const result = await ipcRenderer.invoke('meeting-end');
        
        meetingState.isRecording = false;
        if (meetingState.timerInterval) {
          clearInterval(meetingState.timerInterval);
          meetingState.timerInterval = null;
        }
        
        statusIndicator.className = 'status-indicator ended';
        statusText.textContent = '已结束';
        
        if (result.finalSummary) summaryContent.innerHTML = result.finalSummary;
        
        btnStart.style.display = 'flex';
        btnStart.disabled = false;
      } catch (err) {
        showError(err.message || '结束失败');
        btnEnd.disabled = false;
      }
      
      btnEnd.innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>结束会议';
    };

    // 接收 ASR 结果
    ipcRenderer.on('meeting-asr-result', (event, data) => {
      if (data.speaker) speakerName.textContent = data.speaker;
      if (data.transcript) transcriptText.textContent = data.transcript;
      if (data.summary) summaryContent.innerHTML = data.summary;
    });

    ipcRenderer.on('meeting-error', (event, message) => {
      showError(message);
    });
  </script>
</body>
</html>

